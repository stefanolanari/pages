<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Charts SVG + pdfmake (Bar + Pie)</title>
  <!-- ECharts (SVG renderer) -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <!-- pdfMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 2rem; background:#f7f7f7 }
    .chart-wrap { display:flex; gap:2rem; flex-wrap:wrap }
    .chart-box { background:white; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08) }
  .chart { width:640px; height:360px }
  /* Stile bottone uniforme con gli altri esempi */
  button { padding: 10px 16px; border-radius: 6px; border: none; background: #0077cc; color: white; font-size: 15px; cursor: pointer; }
  button:hover { background: #005fa3; }
    h2 { margin-top:0 }
    .note { font-size:13px; color:#444 }
  </style>
</head>
<body>
  <h2>ECharts (SVG) + pdfmake</h2>
  <p>Prima pagina: grafico a barre + tabella dei dati. Seconda pagina: grafico a torta + tabella dei dati.</p>

  <!-- Solo il bottone visibile: i container dei grafici vengono creati dinamicamente al click -->
  <p style="margin-top:1rem">
    <button id="exportPdf">ðŸ“„ Genera PDF (Bar + Pie)</button>
  </p>

  <script>
    // Dati condivisi (usati sia per i grafici che per le tabelle)
    const categories = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu'];
    const values = [500, 800, 600, 1000, 750, 900];

    // Funzione helper per creare un container off-screen per il rendering SVG
    function createHiddenContainer(id, width = 640, height = 360){
      const d = document.createElement('div');
      d.id = id;
      // Posizioniamo il container fuori dallo schermo in modo che il browser ne calcoli comunque le dimensioni
      // Use position:fixed + top negative to avoid layout reflow issues and set visibility:hidden so it's measurable
      d.style.position = 'fixed';
      d.style.left = '0px';
      d.style.top = '-10000px';
      d.style.width = width + 'px';
      d.style.height = height + 'px';
      d.style.visibility = 'hidden';
      d.style.display = 'block';
      document.body.appendChild(d);
      return d;
    }

    // Opzione per il grafico a barre
    const barOption = {
      title: { text: 'Vendite Mensili', left: 'center' },
      tooltip: { trigger: 'axis' },
      // aggiungiamo un grid con containLabel per lasciare spazio alle etichette e assicurarci
      // che le barre non tocchino il bordo destro (previene clipping)
      grid: { left: '8%', right: '8%', top: '12%', bottom: '12%', containLabel: true },
      xAxis: { type: 'category', data: categories },
      yAxis: { type: 'value' },
      series: [{ type: 'bar', data: values, itemStyle: { color: '#0077cc' } }]
    };

    // Opzione per la torta (convertiamo i dati in array di oggetti)
    const pieData = categories.map((c, i) => ({ name: c, value: values[i] }));
    const pieOption = {
      title: { text: 'Distribuzione Mensile', left: 'center' },
      tooltip: { trigger: 'item' },
      // per evitare che la legenda occupi spazio laterale nella versione PDF,
      // la mettiamo in fondo (orizzontale)
      legend: { orient: 'horizontal', left: 'center', bottom: 0 },
      // radius piÃ¹ contenuto per prevenire overlap con la tabella nel PDF
      series: [{ type: 'pie', radius: '45%', data: pieData }]
    };


    // Aiuta a ottenere l'SVG serializzato da un chart ECharts
    function getChartSvgString(chartInstance){
      const svg = chartInstance.getDom().querySelector('svg');
      if(!svg) return null;
      return new XMLSerializer().serializeToString(svg);
    }

    // Crea il corpo della tabella per pdfMake a partire dai dati
    function buildTableBody(headers, rows){
      const body = [];
      body.push(headers);
      rows.forEach(r => body.push(r));
      return body;
    }

    // Al click, estrai SVG e crea il PDF con due pagine + tabelle
    
    document.getElementById('exportPdf').addEventListener('click', () => {
  // Creiamo dinamicamente i container nascosti per i grafici (fuori schermo)
  // per il grafico a barre usiamo un container piÃ¹ largo per evitare clipping dei bordi
  const barContainer = createHiddenContainer('chartBar_dynamic', 680, 360);
  const pieContainer = createHiddenContainer('chartPie_dynamic', 680, 360);

      // Inizializza i grafici qui (solo nel DOM temporaneo)
      const barChart = echarts.init(barContainer, null, { renderer: 'svg' });
      const pieChart = echarts.init(pieContainer, null, { renderer: 'svg' });

  barChart.setOption(barOption);
  pieChart.setOption(pieOption);
  // Forza il resize dopo aver impostato le opzioni in modo che ECharts calcoli correttamente width/height e viewBox
  try{ barChart.resize(); }catch(e){}
  try{ pieChart.resize(); }catch(e){}

  // Attendi un periodo per sicurezza affinchÃ© ECharts completi il render SVG (timeout aumentato)
  setTimeout(() => {
        try{
          const svgBar = getChartSvgString(barChart);
          const svgPie = getChartSvgString(pieChart);

          if(!svgBar || !svgPie){
            alert('Impossibile ottenere l\'SVG dai grafici generati.');
            return;
          }

          const barHeaders = ['Mese', 'Vendite'];
          const barRows = categories.map((c, i) => [c, values[i]]);

          const pieHeaders = ['Mese', 'Vendite'];
          const pieRows = categories.map((c, i) => [c, values[i]]);

          const docDefinition = {
            content: [
              { text: 'Report: Grafico a Barre', style: 'header' },
              { text: '\n' },
              // usiamo una width ampia per il PDF che rispetti il container SVG generato
              { svg: svgBar, width: 680, alignment: 'center' },
              { text: '\n' },
              { text: 'Tabella dati â€” Grafico a barre', style: 'subheader' },
              {
                table: { widths: ['*', 100], body: buildTableBody(barHeaders, barRows) },
                layout: 'lightHorizontalLines',
                margin: [0, 8, 0, 0]
              },
              { text: '', pageBreak: 'after' },

              { text: 'Report: Grafico a Torta', style: 'header' },
              { text: '\n' },
              { svg: svgPie, width: 680, alignment: 'center', margin: [0, 0, 0, 8] },
              { text: '\n' },
              { text: 'Tabella dati â€” Grafico a torta', style: 'subheader' },
              {
                table: { widths: ['*', 100], body: buildTableBody(pieHeaders, pieRows) },
                layout: 'lightHorizontalLines',
                margin: [0, 14, 0, 0]
              }
            ],
            styles: {
              header: { fontSize: 18, bold: true, alignment: 'center', margin: [0, 0, 0, 6] },
              subheader: { fontSize: 12, bold: true, margin: [0, 8, 0, 4] }
            }
          };

          // Genera il PDF (aperto in una nuova finestra/tab)
          pdfMake.createPdf(docDefinition).open();
        } finally {
          // Pulizia: rimuovi i chart e i container temporanei
          try{ barChart.dispose(); }catch(e){}
          try{ pieChart.dispose(); }catch(e){}
          if(barContainer && barContainer.parentNode) barContainer.parentNode.removeChild(barContainer);
          if(pieContainer && pieContainer.parentNode) pieContainer.parentNode.removeChild(pieContainer);
        }
      }, 300);
    });
  </script>
</body>
</html>